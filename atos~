#!/usr/bin/env zsh
# 
# Script for communicating with the ATOS system
# Author Leon Bonde Larsen <leon@bondelarsen.dk>
#
# To-do:
# _ATOS_PATH is currently hardcoaded
#

run_command ()
# All calls are made through this function in order to allow dryrun
{
	if [ $_DRYRUN = true ]; then
		echo "$*"
		return 0
	fi

	eval "$@"
}

print_error ()
# Outputs error messages
{
	>&2 echo $1
	exit 0
}

exit_SIGINT () 
{
	print_error 'Exiting due to SIGINT'
}

usage() 
{
	print_error "
	usage: ${0##*/} [OPTIONS] unit|all [COMMAND] 

	Communicate with the ATOS system (Artificial Tutoring Of Songbirds)

	OPTIONS
	-d       Dry run. Echoes commands instead of running them.
	-v       Verbose. Outputs all information.

	COMMANDS
	ssh      Connect via ssh
	net      Setup internet gateway
	start    Start unit
	stop     Stop unit
	nop      Do nothing
	"
}

send_ssh()
# Execute command-line on remote machine via ssh
{
	run_command ssh -t -t ${_REMOTE_USER}@${_REMOTE_IP}%eth0 "$@"
}

send_tmux()
# Execute command-line on remote machine in tmux startup-session 
{
	send_ssh "tmux send-keys -t startup:0.0 $@" 
}

setup_environment()
# Set environment variables based on _UNIT variable
{
	if [[ -e $_ATOS_PATH${_UNIT}/_env ]]; then
		source ${_ATOS_PATH}${_UNIT}/_env 
	else
		print_error 'Unit not found'
	fi
}

execute_script()
# Execute command script
{
	if [ -e ${_ATOS_PATH}bin/_${_COMMAND} ]; then
		source ${_ATOS_PATH}bin/_${_COMMAND}
	else
		print_error 'Unknown command!'
		usage
	fi
}

setup_and_execute()
# Setup environment and execute command
{

	echo "Running $_COMMAND on $_UNIT..."
	case $_COMMAND in
		'ssh')
			setup_environment 
			execute_script
			;;
		*)
			{
				setup_environment 
				execute_script
			} 1> >(logger -s -t atos.$_UNIT) 2>&1
	esac
}

# Set default options
_DRYRUN=false

# Parse options
while getopts "dv" opt; do
	case "$opt" in
		d)  echo 'Dry run mode!';_DRYRUN=true      ;;
		v) set -x ;;
	esac
done
shift $(( OPTIND - 1 )); OPTIND=1

# Set script options
set -o errexit
set -o nounset

# Signal trapping
trap exit_SIGINT SIGINT

# Set variables
_ATOS_PATH='/home/leon/scripts/atos/'
_COMMAND=$2
_UNIT=$1

if [ $_UNIT = 'all' ]; then
	for _UNIT in $(avahi-browse -lart | avahi-list | cut -d'.' -f1); do 
		setup_and_execute
        done	       
else
	setup_and_execute
fi



